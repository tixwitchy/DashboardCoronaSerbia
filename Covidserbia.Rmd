---
title: "COVID-19 Srbija - Statistika "
author: "za dan"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
date: '`r format(Sys.Date(),"%d. %m. %Y.")`'

---

```{r setup, include=FALSE}
library(flexdashboard)
library(leaflet)
library(readxl)
library(tidyverse)
library(writexl)
library(httr)
library(plotly)
library(crosstalk)
library(rvest)
library(tmaptools)
library(leaflet)
library(tmap)


#nova updateoana lista 14. april

url2<-"https://data.gov.rs/s/resources/covid-19-zarazheni/20200414-163734/covid-19.xls"
GET(url2, write_disk(tf <- tempfile(fileext = ".xls")))
covidserbianew <- read_excel(tf)
str(covidserbianew)

covidserbianew$Пол <- stringi::stri_trans_general(covidserbianew$Пол, "Serbian-Latin/BGN")
covidserbianew$`Општина (МУП)` <- stringi::stri_trans_general(covidserbianew$`Општина (МУП)`, "Serbian-Latin/BGN")
covidserbianew$`Место (МУП)` <- stringi::stri_trans_general(covidserbianew$`Место (МУП)`, "Serbian-Latin/BGN")

covidserbianew<-covidserbianew%>%
  rename(Pol = Пол)%>%
  rename(NazivTeritorije =`Општина (МУП)`)%>%
  rename(`Mesto(MUP)`=`Место (МУП)`)

  covidserbianew<-covidserbianew%>% 
  mutate(Datum=Sys.Date()-1)%>%
    drop_na(NazivTeritorije)



covidserbianew1<-covidserbianew

covidserbianew1$NazivTeritorije[covidserbianew1$NazivTeritorije=="SAVSKI VENAC"]="BEOGRAD"
covidserbianew1$NazivTeritorije[covidserbianew1$NazivTeritorije=="VOŽDOVAC"]="BEOGRAD"
covidserbianew1$NazivTeritorije[covidserbianew1$NazivTeritorije=="GROCKA"]="BEOGRAD"
covidserbianew1$NazivTeritorije[covidserbianew1$NazivTeritorije=="VRAČAR"]="BEOGRAD"
covidserbianew1$NazivTeritorije[covidserbianew1$NazivTeritorije=="PALILULA"]="BEOGRAD"
covidserbianew1$NazivTeritorije[covidserbianew1$NazivTeritorije=="NOVI BEOGRAD"]="BEOGRAD"
covidserbianew1$NazivTeritorije[covidserbianew1$NazivTeritorije=="ČUKARICA"]="BEOGRAD"
covidserbianew1$NazivTeritorije[covidserbianew1$NazivTeritorije=="ZVEZDARA"]="BEOGRAD"
covidserbianew1$NazivTeritorije[covidserbianew1$NazivTeritorije=="STARI GRAD"]="BEOGRAD"
covidserbianew1$NazivTeritorije[covidserbianew1$NazivTeritorije=="RAKOVICA"]="BEOGRAD"
covidserbianew1$NazivTeritorije[covidserbianew1$NazivTeritorije=="ZEMUN"]="BEOGRAD"
covidserbianew1$NazivTeritorije[covidserbianew1$NazivTeritorije=="SURČIN"]="BEOGRAD"
covidserbianew1$NazivTeritorije[covidserbianew1$NazivTeritorije=="SOPOT"]="BEOGRAD"
covidserbianew1$NazivTeritorije[covidserbianew1$NazivTeritorije=="BARAJEVO"]="BEOGRAD"

covidserbia14.apr<-covidserbianew1%>%
  group_by(`NazivTeritorije`)%>%
  count(NazivTeritorije)





#importing longitude and latitude
municipalitiescsv<-read_csv("longlatcitiesserb.csv",col_names = TRUE)







covidserbialonglat1<-left_join(covidserbia14.apr,municipalitiescsv,by="NazivTeritorije")
duplicated(covidserbialonglat1)
covidserbialonglat1<- covidserbialonglat1[!duplicated(covidserbialonglat1), ]

#cicevac
covidserbialonglat1[24,3]<-21.4437
covidserbialonglat1[24,4]<-43.7213
#curoija

covidserbialonglat1[26,3]<-21.3748
covidserbialonglat1[26,4]<-43.9255
#leposavic
covidserbialonglat1[61,3]<-20.8011
covidserbialonglat1[61,4]<-43.1016

#niska banja
covidserbialonglat1[72,3]<-22.0044
covidserbialonglat1[72,4]<-43.2982
#obilic
covidserbialonglat1[79,3]<-21.0670
covidserbialonglat1[79,4]<-42.6869
#Paracin
covidserbialonglat1[84,3]<-21.4039
covidserbialonglat1[84,4]<-43.8586
#pec
covidserbialonglat1[85,3]<-20.2887
covidserbialonglat1[85,4]<-42.6593

#pecinci
covidserbialonglat1[86,3]<-19.9697
covidserbialonglat1[86,4]<-44.9047




#scraping number of dead

my_html<-read_html("https://covid19.rs/%d1%81%d1%82%d0%b0%d1%82%d0%b8%d1%81%d1%82%d0%b8%d1%87%d0%ba%d0%b8-%d0%bf%d0%be%d0%b4%d0%b0%d1%86%d0%b8-%d0%be-%d0%ba%d0%be%d1%80%d0%be%d0%bd%d0%b0%d0%b2%d0%b8%d1%80%d1%83%d1%81%d1%83/")
scrapingdead<-my_html%>%html_nodes("p")%>%html_text

scrapingdead[which(scrapingdead=="БРОЈ ПРЕМИНУЛИХ")+3]




#zarazeni testirani

zarazenitestirani<-read.csv("zarazenitestirani.csv")
zarazenitestirani$Datum<-as.Date( zarazenitestirani$Datum)

sum(zarazenitestirani$BrojZarazenih)

#shapefile

Serbia_map <- sf::st_read ("gadm36_SRB_shp/gadm36_SRB_2.shp")

Belgrade_map<- Serbia_map[13:29,]
Belgrade_map$NAME_2 <- toupper (Belgrade_map$NAME_2)
Belgrade_map<- dplyr::rename (Belgrade_map, NazivTeritorije = NAME_2)

covidserbBelgrade<-covidserbianew%>%
  group_by(NazivTeritorije)%>%
  count(NazivTeritorije)
Belgrademap_joined <- left_join (Belgrade_map, covidserbBelgrade, key.shp = "NazivTeritorije", key.data = "NazivTeritorije")
Belgrademap_joined<-Belgrademap_joined%>%
  rename(Broj_zaraženih = n)




```

Pregled
==================================================

Row {data-height=185} 
----------------------------------------------------------------

### **Ukupan broj zaraženih**
```{r}
#creation of value box in upper left corner

valueBox(format(scrapingdead[which(scrapingdead=="УКУПАН БРОЈ ОБОЛЕЛИХ")+1],big.mark = ","),color = "#B22222")


```


### **Ukupan broj izlečenih**
```{r}

valueBox(443,color = "green")#,href="http://rs.n1info.com/Vesti/a582261/Koronavirus-u-Srbiji-Interaktivni-grafikoni-sa-brojem-zarazenih-po-gradovima.html")
```

### **Ukupan broj preminulih**
```{r}

valueBox(format(scrapingdead[which(scrapingdead=="БРОЈ ПРЕМИНУЛИХ")+3], big.mark = ","),color = "black")
```


Row {data-height=815} 
-----------------------------------------------------------------------
### **Mapa sa ukupnim brojem zaraženih po opštinama na dan 14.04.**

```{r}


m<-leaflet(covidserbialonglat1) %>% 
  addTiles(attribution = paste(
    "&copy; <a href=\"http://openstreetmap.org\">OpenStreetMap</a> contributors","Podaci preuzeti sa: <a href=\"https://data.gov.rs/sr/datasets/covid-19-zarazheni/\">data.gov.rs</a>","Kontakt za dashboard:<a href=\"mailto:etijana@gmail.com\">Tijana Blagojev </a"))%>%
  setView(lng = 21.0059, lat = 44.0165, zoom = 7)%>%
  addCircles(radius = ~`n`^(.5)*500,weight = 1, color = "black",
             fillColor = "red", fillOpacity = 0.6,  
             popup = ~paste("Opština:", `NazivTeritorije`, "<br>","Broj slučajeva:",`n`, "<br>"))

#addAwesomeMarkers( icon = icon2, popup = ~paste(
# "Grad:", `NazivTeritorije`, "<br>","Broj slučajeva:",`sum(Vrednost)`, "<br>"))

m
```


### **Broj testiranih i broj pozitivnih u Srbiji po danima**

```{r}
gg <- ggplot(zarazenitestirani) +
  geom_area(aes(Datum, `BrojTestiranih`,fill="Testirani"))+
  geom_area(aes(Datum,`BrojZarazenih`,fill= "Pozitivni"))+
 scale_fill_manual(values =  c("#B22222","#4169E1"))+
  scale_x_date(date_breaks = "1 week",date_labels = "%d.%m.")+
  ylab("")+
  xlab("")+
  theme(
        legend.title = element_blank(),
        panel.background = element_blank(),
       plot.margin = margin(0, 0, 2.2, 0, "cm"),
        plot.caption = element_text()
  )



  ggplotly( gg) %>%
  layout(legend = list(
      orientation = "h"), annotations = 
 list(x = 1, y = -0.3, text = "Podaci preuzeti sa: <a href=\"https://covid19.rs/статистички-подаци-о-коронавирусу/\">covid19.rs</a>", 
      showarrow = F, xref='paper', yref='paper', 
      xanchor='right', yanchor='auto', xshift=0, yshift=0,
      font=list(size=9)))

```

Beograd i informacije o podacima
==================================================

Row {data-height=1000} 
-----------------------------------------------------------------------
### **Broj slučajeva po opštinama u Beogradu na dan 14.03.** 

```{r}


map <- tm_shape(Belgrademap_joined)+
  tmap_style("cobalt") +

        tm_polygons(col = "Broj_zaraženih",title = "Broj zaraženih",id = "NazivTeritorije",palette = "YlOrRd",popup.vars = c(
							   "Broj zaraženih:"= "Broj_zaraženih"),	popup.format = list()
			)+
        #tm_layout(title = "Government Financing of Media per Region from 2015-2017")+
        tm_view(text.size.variable = TRUE, view.legend.position = c("right","top"))
      
      leafmap<-tmap_leaflet(map) %>%
        setView(lng =20.3850, lat = 44.6835, zoom = 9)
       
   
      leafmap
      

```

### **Informacije o podacima** {align=justify}

Ovaj dashboard prikuplja podatke sa sajta [Covid19.rs](https://covid19.rs/статистички-подаци-о-коронавирусу/) o ukupnom broju zaraženih, umrlih, kao i o broju testiranih i pozitivnih za svaki dan od pojave prvog slučaja u Srbiji. Ovi podaci se ažuriraju odmah nakon konferencija za štampu kriznog štaba. Podaci o izlečenim se ažuriraju na osnovu izjava zdravstvenih stručnjaka sa ovih konferencija jer ih nema na drugim mestima. 

Sajt [data.gov.rs](https://data.gov.rs/sr/datasets/covid-19-zarazheni/) je započeo dobru praksu objavljivanja podataka koji se odnose na geografski raspored zaraženih zajedno sa vremenskom odrednicom ali oni su se, nažalost, ažurirali do 29. marta. To se promenilo 14. aprila kada su objavljeni podaci koji su u drugačijem formatu u odnosu na prethodni skup podataka i koji se ne ažuriraju. Ti podaci se koriste za mape za Beograd i za Srbiju. 

Ovakav pristup otvaranju podataka dovodi do nemogućnosti da se urade valjane analize i doprinese transparentnom praćenju procesa tokom pandemije. Sa druge strane, ti isti podaci nam daju bar male naznake pojedinih trendova koji mogu da se prate. 

